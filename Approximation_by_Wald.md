## Wald의 SPRT 근사 공식 유도

Abraham Wald는 순차 확률 비율 검정(SPRT)에서 상한선(A)과 하한선(B)을 설정하는 근사 공식을 유도했습니다. 이 공식은 검정의 제1종 오류($\alpha$)와 제2종 오류($\beta$)를 기반으로 합니다. 유도 과정은 다소 복잡하지만, 핵심 아이디어는 검정이 종료되는 시점에서 확률 비율 $L_m$이 경계 값 A 또는 B에 거의 도달한다는 가정에 기반합니다.

### 1. 기본 설정 및 가정

SPRT는 두 가지 단순 가설 $H_0: \theta = \theta_0$와 $H_1: \theta = \theta_1$을 검정합니다.
누적 확률 비율 $L_m = \frac{P(X_1, \dots, X_m | H_1)}{P(X_1, \dots, X_m | H_0)}$ 입니다.
결정 규칙은 $L_m \ge A$이면 $H_1$ 채택, $L_m \le B$이면 $H_0$ 채택, 그 외에는 검정 계속입니다.

우리가 정의한 오류 확률은 다음과 같습니다:
*   **제1종 오류($\alpha$):** $H_0$가 참일 때 $H_1$을 채택할 확률 ($P(\text{Reject } H_0 | H_0 \text{ is true})$)
*   **제2종 오류($\beta$):** $H_1$이 참일 때 $H_0$를 채택할 확률 ($P(\text{Fail to reject } H_0 | H_1 \text{ is true})$)

Wald의 유도는 검정이 종료될 때 $L_m$이 경계 A 또는 B를 **정확히** 맞춘다고 가정하는 데서 시작합니다. 물론 실제로는 경계를 넘어설 수 있지만, 근사 유도에서는 이 가정을 사용합니다.

### 2. 제1종 오류($\alpha$)와 제2종 오류($\beta$)의 정의 확장

검정이 종료되는 시나리오는 다음과 같습니다:
1.  **$H_1$을 채택하고 종료:** $L_m \ge A$
2.  **$H_0$를 채택하고 종료:** $L_m \le B$

이 시나리오들을 바탕으로 오류 확률을 다시 써보면:

*   $\alpha = P(L_m \ge A \text{ at termination } | H_0)$
*   $\beta = P(L_m \le B \text{ at termination } | H_1)$

그리고 각 가설이 참일 때 올바른 결정을 내릴 확률은:

*   $1-\alpha = P(L_m \le B \text{ at termination } | H_0)$
*   $1-\beta = P(L_m \ge A \text{ at termination } | H_1)$

### 3. Wald의 핵심 아이디어 및 근사

Wald는 $H_0$가 참일 때 $L_m$이 B에 도달할 확률을 $1-\alpha$로, A에 도달할 확률을 $\alpha$로, 그리고 $H_1$이 참일 때 $L_m$이 B에 도달할 확률을 $\beta$로, A에 도달할 확률을 $1-\beta$로 근사했습니다.

여기서 핵심은 **$L_m$이 경계에 도달할 때의 확률 분포**에 대한 통찰입니다.

우선, $H_0$가 참일 때 $L_m$이 $A$에 도달하는 사건과 $B$에 도달하는 사건에 대해 생각해 봅시다.
$H_0$가 참일 때, $L_m$은 일반적으로 1에 가까운 값에서 시작하여 **아래로($H_0$를 지지하는 방향으로)** 이동하는 경향이 있습니다.

반대로, $H_1$이 참일 때, $L_m$은 **위로($H_1$을 지지하는 방향으로)** 이동하는 경향이 있습니다.

### 4. 근사 공식 유도 단계

**단계 1: $H_0$가 참일 경우**

$H_0$가 참일 때, $L_m$이 경계 A에 도달할 확률은 $\alpha$이고, B에 도달할 확률은 $1-\alpha$입니다.
검정이 종료될 때, $L_m$은 거의 $A$이거나 $B$라고 가정합니다.

이제, 확률 비율의 기댓값에 대한 관계를 생각해 봅시다.
$H_0$가 참이라고 가정할 때, 종료될 때의 $L_m$의 기댓값은 다음과 같이 쓸 수 있습니다:

$E_0[L_m | \text{termination}] = \alpha \times A + (1-\alpha) \times B$

(여기서 $E_0$는 $H_0$가 참일 때의 기댓값입니다.)

동시에, $E_0[L_m]$은 1이 되어야 합니다. 이는 $H_0$가 참일 때 $L_m$의 기댓값은 1이기 때문입니다. (이는 확률 비율 검정의 중요한 속성 중 하나로, 확률 측정의 라돈-니코딤(Radon-Nikodym) 도함수의 기댓값은 1이라는 사실에서 비롯됩니다).
**이는 핵심적인 Wald의 근사입니다.** 엄밀히 말하면 이는 $L_m$이 종료되기 직전의 분포를 정확히 반영하는 것은 아니지만, Wald는 이 근사를 통해 실용적인 경계를 얻었습니다.

따라서,
$1 \approx \alpha A + (1-\alpha) B$  **(식 1)**

**단계 2: $H_1$가 참일 경우**

$H_1$가 참일 때, $L_m$이 경계 A에 도달할 확률은 $1-\beta$이고, B에 도달할 확률은 $\beta$입니다.
마찬가지로, $H_1$가 참일 때 종료될 때의 $L_m$의 기댓값은 다음과 같습니다:

$E_1[L_m | \text{termination}] = (1-\beta) \times A + \beta \times B$

이제, $E_1[L_m]$을 생각해 봅시다. $H_1$이 참일 때, $L_m$은 $H_1$에 대한 확률 밀도의 비율이므로 $E_1[L_m]$은 1이 아닙니다. 이 부분은 초보자에게 혼란을 줄 수 있는 부분입니다. $H_1$이 참일 때 $L_m$의 기댓값은 $E_1[\frac{P_1}{P_0}]$입니다.

하지만 Wald는 여기에서 다른 트릭을 사용합니다. 그는 $H_0$가 참이라고 가정하고, 확률 측정 $P_0$ 하에서의 $L_m$의 기댓값을 사용했습니다. 즉, $P_0(L_m \ge A)$가 $\alpha$ 이고, $P_0(L_m \le B)$가 $1-\alpha$입니다.
$P_1(L_m \ge A)$가 $1-\beta$ 이고, $P_1(L_m \le B)$가 $\beta$입니다.

이것을 재구성하면:
우리는 $H_0$를 받아들일 때의 확률 $P_0(L_m \le B)$와 $P_1(L_m \le B)$를 알고 싶습니다.
그리고 $H_1$을 받아들일 때의 확률 $P_0(L_m \ge A)$와 $P_1(L_m \ge A)$를 알고 싶습니다.

$P_0(L_m \ge A) = \alpha$
$P_0(L_m \le B) = 1-\alpha$

$P_1(L_m \ge A) = 1-\beta$
$P_1(L_m \le B) = \beta$

핵심은, 가설 $H_0$ 하에서의 $L_m$이 $L_m$ 그 자체와 동일한 것이 아니라, 그 값을 **가중 평균**으로 생각하는 것입니다.

*   $H_0$가 참일 때, $L_m$이 $A$에 도달하는 경우를 (가중치 $\alpha$)로 보고, $B$에 도달하는 경우를 (가중치 $1-\alpha$)로 봅니다.
*   $H_1$가 참일 때, $L_m$이 $A$에 도달하는 경우를 (가중치 $1-\beta$)로 보고, $B$에 도달하는 경우를 (가중치 $\beta$)로 봅니다.

이제, **오류가 발생할 확률**을 이용해 경계 A와 B를 근사합니다.

$H_0$가 참일 때, $H_1$을 채택하는 경우 (오류 $\alpha$) $L_m$은 $A$에 도달합니다.
$H_1$이 참일 때, $H_0$를 채택하는 경우 (오류 $\beta$) $L_m$은 $B$에 도달합니다.

여기서 Wald는 다음과 같은 직관적인 아이디어를 사용했습니다:
$H_0$가 참일 때, $L_m$이 $A$에 도달할 확률은 $\alpha$입니다. 이때, $L_m \approx A$ 입니다.
$H_0$가 참일 때, $L_m$이 $B$에 도달할 확률은 $1-\alpha$입니다. 이때, $L_m \approx B$ 입니다.

마찬가지로,
$H_1$이 참일 때, $L_m$이 $A$에 도달할 확률은 $1-\beta$입니다. 이때, $L_m \approx A$ 입니다.
$H_1$이 참일 때, $L_m$이 $B$에 도달할 확률은 $\beta$입니다. 이때, $L_m \approx B$ 입니다.

이제, 이 가정을 사용하여 A와 B에 대한 관계식을 유도합니다.

확률 비율 $L_m$의 특성을 이용합니다. 만약 검정이 종료되고 $H_0$가 참인데 $H_1$을 채택했다면, 우리는 $\alpha$의 확률로 $L_m \ge A$인 상황을 목격한 것입니다. 이때 $L_m$은 $A$에 가깝다고 가정합니다.

반대로, $H_1$이 참인데 $H_0$를 채택했다면, 우리는 $\beta$의 확률로 $L_m \le B$인 상황을 목격한 것입니다. 이때 $L_m$은 $B$에 가깝다고 가정합니다.

이러한 상황들을 고려하여 다음의 두 근사 관계를 설정할 수 있습니다.

$P(L_m \ge A \text{ and } H_0 \text{ is true}) \approx \alpha$
$P(L_m \le B \text{ and } H_1 \text{ is true}) \approx \beta$

그리고,
$P(L_m \le B \text{ and } H_0 \text{ is true}) \approx 1-\alpha$
$P(L_m \ge A \text{ and } H_1 \text{ is true}) \approx 1-\beta$

이제, 다음의 비율을 생각해 봅시다.

$\frac{P(L_m \ge A \text{ and } H_1 \text{ is true})}{P(L_m \ge A \text{ and } H_0 \text{ is true})} = \frac{1-\beta}{\alpha}$

근사적으로, $L_m \approx A$ 일 때 이 비율은 $A$가 됩니다. (즉, $\frac{P(X|H_1)}{P(X|H_0)} = L_m \approx A$)
따라서:
$A \approx \frac{1-\beta}{\alpha}$

마찬가지로, $L_m \le B$ 일 때의 비율을 생각해 봅시다.
$\frac{P(L_m \le B \text{ and } H_1 \text{ is true})}{P(L_m \le B \text{ and } H_0 \text{ is true})} = \frac{\beta}{1-\alpha}$

근사적으로, $L_m \approx B$ 일 때 이 비율은 $B$가 됩니다.
따라서:
$B \approx \frac{\beta}{1-\alpha}$

이것이 Wald의 근사 공식이 유도되는 핵심입니다. 이 유도 과정은 수학적으로 엄밀하지 않고 몇 가지 중요한 가정을 포함하고 있습니다. 특히, 검정이 종료될 때 확률 비율이 경계에 정확히 도달한다는 가정은 "overshoot" 현상을 무시하는 것입니다. 즉, 실제로는 $L_m$이 경계를 약간 넘어설 수 있습니다.

### 5. overshoot (오버슛)와 실제 오류 확률

이러한 오버슛 현상 때문에, Wald의 근사 공식으로 계산된 경계 A와 B를 사용하면 실제 제1종 오류($\alpha'$)는 $\alpha$보다 작아지고, 실제 제2종 오류($\beta'$)도 $\beta$보다 작아지는 경향이 있습니다. 즉, 검정은 설계된 것보다 **더 보수적**이게 됩니다. 이는 대부분의 응용 분야에서 문제가 되지 않으며, 오히려 안전 마진을 제공하는 것으로 간주될 수 있습니다.

더 정밀한 경계를 얻기 위한 수정 공식들도 존재하지만, Wald의 간결한 근사 공식은 그 실용성과 효율성 때문에 여전히 널리 사용되고 있습니다.

**요약하자면, Wald의 SPRT 근사 공식은 다음 두 가지 주요 가정에 기반합니다:**

1.  검정이 종료될 때 누적 확률 비율 $L_m$이 정확히 경계 A 또는 B에 도달한다.
2.  이때, 오류 확률 $\alpha$와 $1-\alpha$ (또는 $\beta$와 $1-\beta$)가 경계에 도달하는 확률과 비례한다.

이러한 가정을 통해, 오류 확률을 경계 값으로 직접 연결하는 간단하면서도 효과적인 공식이 도출됩니다.
